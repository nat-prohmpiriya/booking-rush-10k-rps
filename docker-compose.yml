# Production Docker Compose
# Usage: docker-compose up -d

services:
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: backend-api-gateway
    image: booking-rush/api-gateway:latest
    container_name: booking-rush-gateway
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - AUTH_SERVICE_URL=http://auth:8081
      - TICKET_SERVICE_URL=http://ticket:8082
      - BOOKING_SERVICE_URL=http://booking:8083
      - PAYMENT_SERVICE_URL=http://payment:8084
    env_file:
      - .env
    depends_on:
      auth:
        condition: service_healthy
      ticket:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - booking-rush

  auth:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: backend-auth
    image: booking-rush/auth:latest
    container_name: booking-rush-auth
    ports:
      - "8081:8081"
    environment:
      - SERVER_PORT=8081
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - booking-rush

  ticket:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: backend-ticket
    image: booking-rush/ticket:latest
    container_name: booking-rush-ticket
    ports:
      - "8082:8082"
    environment:
      - SERVER_PORT=8082
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - booking-rush

  booking:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: backend-booking
    image: booking-rush/booking:latest
    container_name: booking-rush-booking
    ports:
      - "8083:8083"
    environment:
      - SERVER_PORT=8083
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - booking-rush

  payment:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: backend-payment
    image: booking-rush/payment:latest
    container_name: booking-rush-payment
    ports:
      - "8084:8084"
    environment:
      - SERVER_PORT=8084
      - AUTH_SERVICE_URL=http://auth:8081
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - booking-rush

  frontend:
    build:
      context: ./frontend-web
      dockerfile: Dockerfile
    image: booking-rush/frontend:latest
    container_name: booking-rush-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1
    depends_on:
      - api-gateway
    restart: unless-stopped
    networks:
      - booking-rush

  inventory-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        SERVICE: backend-booking
        WORKER: inventory-worker
    image: booking-rush/inventory-worker:latest
    container_name: booking-rush-inventory-worker
    environment:
      - SERVICE_NAME=inventory-worker
    env_file:
      - .env
    depends_on:
      booking:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - booking-rush

  queue-release-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        SERVICE: backend-booking
        WORKER: queue-worker
    image: booking-rush/queue-release-worker:latest
    container_name: booking-rush-queue-release-worker
    environment:
      - SERVICE_NAME=queue-release-worker
    env_file:
      - .env
    depends_on:
      booking:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - booking-rush

networks:
  booking-rush:
    driver: bridge
