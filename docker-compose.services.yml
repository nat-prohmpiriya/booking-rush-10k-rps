# Docker Compose for Backend Services with Air hot reload
# Usage: docker-compose -f docker-compose.services.yml up
# Requires: docker-compose -f docker-compose.db.yml up -d (run first)

services:
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-gateway
    working_dir: /app/backend-api-gateway
    command: air -c /app/.air.toml
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - AUTH_SERVICE_URL=http://auth:8081
      - TICKET_SERVICE_URL=http://ticket:8082
      - BOOKING_SERVICE_URL=http://booking:8083
      - PAYMENT_SERVICE_URL=http://payment:8084
      - REDIS_HOST=redis
      - KAFKA_BROKERS=redpanda:9092
    env_file:
      - .env.local
    volumes:
      - ./backend-api-gateway:/app/backend-api-gateway
      - ./pkg:/app/pkg
      - ./scripts:/app/scripts
      - ./.air.toml:/app/.air.toml
    depends_on:
      - auth
      - ticket
    networks:
      - booking-rush-local

  auth:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-auth
    working_dir: /app/backend-auth
    command: air -c /app/.air.toml
    ports:
      - "8081:8081"
    environment:
      - SERVER_PORT=8081
      - DATABASE_HOST=postgres
      - AUTH_DATABASE_HOST=postgres
      - REDIS_HOST=redis
      - KAFKA_BROKERS=redpanda:9092
    env_file:
      - .env.local
    volumes:
      - ./backend-auth:/app/backend-auth
      - ./pkg:/app/pkg
      - ./.air.toml:/app/.air.toml
    networks:
      - booking-rush-local

  ticket:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-ticket
    working_dir: /app/backend-ticket
    command: air -c /app/.air.toml
    ports:
      - "8082:8082"
    environment:
      - SERVER_PORT=8082
      - DATABASE_HOST=postgres
      - TICKET_DATABASE_HOST=postgres
      - REDIS_HOST=redis
      - KAFKA_BROKERS=redpanda:9092
    env_file:
      - .env.local
    volumes:
      - ./backend-ticket:/app/backend-ticket
      - ./pkg:/app/pkg
      - ./.air.toml:/app/.air.toml
    networks:
      - booking-rush-local

  booking:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-booking
    working_dir: /app/backend-booking
    command: air -c /app/.air.toml
    ports:
      - "8083:8083"
    environment:
      - SERVER_PORT=8083
      - DATABASE_HOST=postgres
      - BOOKING_DATABASE_HOST=postgres
      - REDIS_HOST=redis
      - KAFKA_BROKERS=redpanda:9092
      - TICKET_SERVICE_URL=http://ticket:8082
    env_file:
      - .env.local
    volumes:
      - ./backend-booking:/app/backend-booking
      - ./pkg:/app/pkg
      - ./scripts:/app/scripts
      - ./.air.toml:/app/.air.toml
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8083/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - booking-rush-local

  payment:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-payment
    working_dir: /app/backend-payment
    command: air -c /app/.air.toml
    ports:
      - "8084:8084"
    environment:
      - SERVER_PORT=8084
      - AUTH_SERVICE_URL=http://auth:8081
      - DATABASE_HOST=postgres
      - PAYMENT_DATABASE_HOST=postgres
      - REDIS_HOST=redis
      - KAFKA_BROKERS=redpanda:9092
    env_file:
      - .env.local
    volumes:
      - ./backend-payment:/app/backend-payment
      - ./pkg:/app/pkg
      - ./.air.toml:/app/.air.toml
    networks:
      - booking-rush-local

  frontend:
    build:
      context: ./frontend-web
      dockerfile: Dockerfile.dev
    container_name: booking-rush-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1
    volumes:
      - ./frontend-web:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - api-gateway
    networks:
      - booking-rush-local

  inventory-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        SERVICE: backend-booking
        WORKER: inventory-worker
    image: booking-rush/inventory-worker:latest
    container_name: booking-rush-inventory-worker
    environment:
      - SERVICE_NAME=inventory-worker
      - DATABASE_HOST=postgres
      - BOOKING_DATABASE_HOST=postgres
      - REDIS_HOST=redis
      - KAFKA_BROKERS=redpanda:9092
    env_file:
      - .env.local
    depends_on:
      booking:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - booking-rush-local

  queue-release-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        SERVICE: backend-booking
        WORKER: queue-worker
    image: booking-rush/queue-release-worker:latest
    container_name: booking-rush-queue-release-worker
    environment:
      - SERVICE_NAME=queue-release-worker
      - DATABASE_HOST=postgres
      - BOOKING_DATABASE_HOST=postgres
      - REDIS_HOST=redis
      - KAFKA_BROKERS=redpanda:9092
    env_file:
      - .env.local
    depends_on:
      booking:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - booking-rush-local

networks:
  booking-rush-local:
    external: true
