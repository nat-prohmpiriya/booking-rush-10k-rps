# Docker Compose for Backend Services with Air hot reload
# Usage: docker-compose -f docker-compose.services.yml up
# Requires: docker-compose -f docker-compose.db.yml up -d (run first)

services:
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-gateway
    working_dir: /app/backend-api-gateway
    command: air -c /app/.air.toml
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
    env_file:
      - .env.local
    volumes:
      - ./backend-api-gateway:/app/backend-api-gateway
      - ./pkg:/app/pkg
      - ./scripts:/app/scripts
      - ./.air.toml:/app/.air.toml
    depends_on:
      - auth
      - ticket
    networks:
      - booking-rush-local

  auth:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-auth
    working_dir: /app/backend-auth
    command: air -c /app/.air.toml
    ports:
      - "8081:8081"
    environment:
      - SERVER_PORT=8081
    env_file:
      - .env.local
    volumes:
      - ./backend-auth:/app/backend-auth
      - ./pkg:/app/pkg
      - ./.air.toml:/app/.air.toml
    networks:
      - booking-rush-local

  ticket:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-ticket
    working_dir: /app/backend-ticket
    command: air -c /app/.air.toml
    ports:
      - "8082:8082"
    environment:
      - SERVER_PORT=8082
    env_file:
      - .env.local
    volumes:
      - ./backend-ticket:/app/backend-ticket
      - ./pkg:/app/pkg
      - ./.air.toml:/app/.air.toml
    networks:
      - booking-rush-local

  booking:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-booking
    working_dir: /app/backend-booking
    command: air -c /app/.air.toml
    ports:
      - "8083:8083"
    environment:
      - SERVER_PORT=8083
    env_file:
      - .env.local
    volumes:
      - ./backend-booking:/app/backend-booking
      - ./pkg:/app/pkg
      - ./scripts:/app/scripts
      - ./.air.toml:/app/.air.toml
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8083/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - booking-rush-local

  payment:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: booking-rush-payment
    working_dir: /app/backend-payment
    command: air -c /app/.air.toml
    ports:
      - "8084:8084"
    environment:
      - SERVER_PORT=8084
    env_file:
      - .env.local
    volumes:
      - ./backend-payment:/app/backend-payment
      - ./pkg:/app/pkg
      - ./.air.toml:/app/.air.toml
    networks:
      - booking-rush-local

  frontend:
    build:
      context: ./frontend-web
      dockerfile: Dockerfile.dev
    container_name: booking-rush-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1
    volumes:
      - ./frontend-web:/app
    depends_on:
      - api-gateway
    networks:
      - booking-rush-local

  inventory-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        SERVICE: backend-booking
        WORKER: inventory-worker
    image: booking-rush/inventory-worker:latest
    container_name: booking-rush-inventory-worker
    environment:
      - SERVICE_NAME=inventory-worker
    env_file:
      - .env.local
    depends_on:
      booking:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - booking-rush-local

  queue-release-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        SERVICE: backend-booking
        WORKER: queue-worker
    image: booking-rush/queue-release-worker:latest
    container_name: booking-rush-queue-release-worker
    environment:
      - SERVICE_NAME=queue-release-worker
    env_file:
      - .env.local
    depends_on:
      booking:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - booking-rush-local

  # ============================================
  # Saga Pattern Workers
  # ============================================

  saga-orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        SERVICE: backend-booking
        WORKER: saga-orchestrator
    image: booking-rush/saga-orchestrator:latest
    container_name: booking-rush-saga-orchestrator
    environment:
      - SERVICE_NAME=saga-orchestrator
    env_file:
      - .env.local
    depends_on:
      booking:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - booking-rush-local

  saga-step-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        SERVICE: backend-booking
        WORKER: saga-step-worker
    image: booking-rush/saga-step-worker:latest
    container_name: booking-rush-saga-step-worker
    environment:
      - SERVICE_NAME=saga-step-worker
    env_file:
      - .env.local
    depends_on:
      - saga-orchestrator
    restart: unless-stopped
    networks:
      - booking-rush-local

  saga-payment-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      args:
        SERVICE: backend-payment
        WORKER: saga-payment-worker
    image: booking-rush/saga-payment-worker:latest
    container_name: booking-rush-saga-payment-worker
    environment:
      - SERVICE_NAME=saga-payment-worker
      - PAYMENT_GATEWAY=mock  # Override to use mock for saga testing
    env_file:
      - .env.local
    depends_on:
      - saga-orchestrator
    restart: unless-stopped
    networks:
      - booking-rush-local

networks:
  booking-rush-local:
    external: true
